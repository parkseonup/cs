# 8. 가상 메모리 관리

## 요구 페이징

### 요구 페이징의 개요

- 요구 페이징(demand paging)
  - 사용자가 기능을 요구할 때 해당 페이지를 메모리로 가져오는 것
  - 스와핑이 아닌, 게으른 스와퍼 방식을 따른다.
    - 스와핑(swapping): 프로세스를 구성하는 모든 페이지를 메모리에 올리는 것
    - 게이른 스와퍼(lazy swapper): 사용자가 요구할 때 메모리에 올리는 것
- 미리 가져오기: 요구 페이징과 반대. 필요할 것을 예측하고 페이지를 미리 가져오는 방식 (ex 캐시)
- 미리 가져온 데이터가 필요없을 경우 리소스 낭비가 생기므로, 현대의 운영체제는 요구 페이징을 사용한다.

### 페이지 테이블 엔트리의 구조

- 페이지 테이블 엔트리(PTE, Page Table Entry)란 페이지 테이블의 한 행을 의미함
- 페이지 번호, 플래그 비트, 프레임 번호로 구성됨
- 플래그 비트: CPU에 따라 비트 구성이 달라질 수 있다.
  - 접근 비트(access bit)
    - === 참조 비트(reference bit)
    - 페이지가 메모리에 올라온 후 사용한 적이 있는지 표시
  - 변경 비트(modified bit)
    - === dirty bit
    - 페이지가 메모리에 올라온 후 데이터 변경이 있었는지 표시
  - 유효 비트(valid bit)
    - === 현재 비트(present bit)
    - 페이지가 실제 메모리에 있는지 표시
    - 실제 메모리에 있으면 0, 스왑 영역에 있으면 1로 표시됨
  - 접근 권한 비트(rights bit)
    - 읽기 비트(read bit), 쓰기 비트(write bit), 실행 비트(execute bit)를 합친 말
    - 읽기, 쓰기, 실행에 대한 권한이 있는지 표시
    - 권한이 없는 프로세스가 쓰려고 할 때 접근을 차단하기 위해 사용된다.
- 프레임 번호
  - 가상 주소의 페이지가 어느 프레임에 있는지 알려주는 자료구조. 페이지 테이블의 핵심.
  - === 주소 필드(address field)

### 페이지 부재

- 페이지 부재(page fault): 프로세스가 페이지를 요청했을 때 그 페이지가 메모리에 없는 상황
- 페이지 부재가 발생하면 해당 페이지를 스왑영역에서 메모리 영역으로 옮겨야 한다.
- 페이지 부재시 메모리 관리자의 작업
  1. 프로세스가 어떤 페이지를 요청하면 페이지 테이블의 유효 비트를 확인하고,
  2. 페이지 부재가 발생할 경우, 메모리 관리자는 스왑 영역에 접근하고,
  3. 해당 페이지를 메모리의 비어 있는 프레임에 가져오거나 기존 페이지와 교체한다.
  4. 이후 해당 페이지가 담긴 프레임에 접근하여 해당 데이터를 프로세스에 넘긴다.

## 페이지 교체 알고리즘

- 페이지 교체 알고리즘(page replacement algorithm): 메모리에 빈 프레임이 없을 때 메모리에 있는 프레임 중 하나를 스왑 영역으로 내보내고, 스왑 영역에 있던 페이지를 메모리에 갱신하는 것
- 대상 페이지(victim page): 페이지 교체 알고리즘에 의해 스왑 영역으로 내보내질 페이지

### 페이지 교체 알고리즘 종류

- 간단한 알고리즘
  - 무작위 알고리즘
  - FIFO 알고리즘: 큐를 이용하여 메모리에 가장 먼저 진입한 페이지를 대상 페이지로 지정하는 알고리즘이다.
- 최적 알고리즘: 앞으로 어떤 페이지가 사용될 지를 파악하고 사용되지 않는 페이지를 제거하는 알고리즘으로, 미래를 정확히 예측할 수 없기 때문에 현실적으로 사용이 불가능하다.
- 최적 근접 알고리즘
  - LRU(Least Recently Used): 최근 사용이 적은 페이지를 대상 페이지로 지정하는 알고리즘으로, 시간이나 카운터 등을 표시하는 추가 공간이 필요하기 때문에 메모리 낭비가 생긴다.
    - 페이지 접근 시간에 기반한 구현
    - 카운터에 기반한 구현
    - 참조 비트 시프트 방식
  - LFU(Least Frequently Used): 사용 빈도가 가장 적은 페이지를 대상 페이지로 지정하는 알고리즘으로, 페이지 접근 횟수(빈도)를 표시하는 추가 공간이 필요하기 때문에 메모리 낭비가 생긴다.
  - NUR(Not Used Recently)
    - 최근에 사용되지 않은 페이지를 대상 페이지로 지정하는 알고리즘이다.
    - LFU와 달리 참조 비트(1bit)와 변경 비트(1bit), 즉 단 2bit의 추가 메모리를 이용하여 접근 상태를 표현하기 때문에 가장 많이 사용된다.
    - 참조 비트와 변경 비트는 각 접근에 따라 0, 1로 표현이 된다.
  - FIFO 변형 알고리즘
    - 2차 기회 페이지 교체 알고리즘
      - FIFO 알고리즘을 따르되, 페이지에 접근한 경우 해당 페이지를 큐의 맨 마지막으로 옮겨 대상 페이지로 선정될 확률을 낮추는 알고리즘이다.
      - 큐를 유지하는 비용이 높고, 큐 안에서 중간 순서를 바꾸는 비용이 높은 행위가 필요하다는 단점이 있다.
    - 시계 알고리즘
      - 2차 기회 페이지 교체 알고리즘의 큐를 원형 큐로 구현하고, 참조 비트와 포인터를 이용하여 대상 페이지를 지정한다.
      - 포인터가 참조 비트가 1인 페이지에 이동한 경우, 참조 비트를 0으로 초기화하고 다음 페이지로 이동하여 참조 비트가 0이 아닌 페이지를 대상 페이지로 지정한다.

## 스레싱과 프레임 할당

### 스레싱

- 스레싱(threshing)이란 잦은 페이지 부재로 작업이 멈춘 것 같은 상태를 말함

### 스레싱과 멀티프로그래밍 정도의 상관관계

- 멀티프로그래밍 정도(degree of multiprogramming): 동시에 실행하는 프로그램의 수
- 멀티프로그래밍 정도가 너무 높으면 스레싱이 발생함
- 일정 크기까지 물리메모리를 늘리면 스레싱 발생 지점이 늦춰져서 프로세스를 원만하게 실행할 수 있다.
  - 스레싱 발생 지점(threshing point): 프로그램의 수가 적을 때는 CPU 사용률이 계속 증가하다가 메모리가 꽉 차면 CPU가 작업하는 시간보다 스왑 영역으로 페이지를 보내고 새로운 페이지를 메모리로 가져오는 작업이 빈법해져 CPU가 작업할 수 없는 상태에 이르는 것

### 스레싱과 프레임 할당의 상관관계

- 실행 중인 여러 프로세스에 프레임을 얼마나 나눠주냐에 따라 시스템의 성능이 달라짐
- 프레임 할당 방식은 크게 정적 할당과 동적 할당으로 나눠짐
- 정적 할당(static allocation): 프로세스 실행 초기에 프레임을 나눠준 후 그 크기를 고정하는 것
  - 균등 할당(equal allocation) 방식
    - 프로세스의 크기와 상관없이 사용 가능한 프레임을 모든 프로세스에 동일하게 할당함
    - 단점: 크기가 큰 프로세스의 경우 필요한 만큼 프레임을 할당 받지 못해서 페이지 부재가 빈번하게 발생하고, 크기가 작은 프로세스의 경우 메모리 낭비가 생김
  - 비례 할당(proportional allocation)
    - 프로세스 크기에 비례하여 프레임을 할당하는 방식
    - 프로세스별 프레임 수 = 해당 프로세스가 필요로 하는 총 프레임 개수 \* 가용 프레임 개수 / 전체 프로세스의 총 프레임 개수
    - 단점
      - 프로세스가 실행 중에 필요로 하는 프레임을 유동적으로 반영하지 못한다. (ex 동영상 플레이어의 경우 실행되는 동안 큰 메모리를 필요로 함)
      - 당장 필요 없는 프레임을 미리 할당해 놓기 때문에 메모리 낭비가 생긴다.
- 동적 할당(dynamic allocation): 변하는 요청을 수용하는 방식
  - 작업 집합 모델 방식(working set model)
    - 지역성 이론을 바탕으로, 최근 일정 시간 동안 참조된 페이지들을 집합으로 만들고 해당 페이지들을 물리 메모리에 유지하는 방식
    - 작업집합 크기(working set size): 물리 메모리에 유지할 페이지의 크기
    - 작업집합 윈도우(wsw, Working Set Window): 작업집합에 포함되는 페이지의 범위. 현재 시점에서 최대 어느 범위까지의 페이지를 살펴볼 것인가.
  - 페이지 부재 빈도(page fault frequency)
    - 페이지 부재 횟수를 기록해서 페이지 부재 비율을 계산하는 방식
    - 페이지 부재 비율이 상한선을 초과하면 프레임을 추가해서 늘리고, 페이지 부재 비율이 하한선 밑으로 내려가면 할당한 프레임을 회수한다.
    - 프로세스가 처음 시작될 때는 페이지 할당량을 예측할 수 없으므로, 프로세스를 실행하면서 추가적으로 페이지를 할당하거나 회수하여 적정 페이지 할당량을 조절한다.

### 스레싱과 페이지 교체 방식의 상관관계

- 어떤 프로세스를 대상으로 페이지 교체 알고리즘을 적용할 지에 따라 전역 교체 방식, 지역 교체 방식으로 나뉜다.
- 전역 교체(global replacement) 방식: 물리 메모리에 올라와있는 전체 프레임을 대상으로 교체 알고리즘을 적용하여 대상 페이지를 선정함
- 지역 교체(local replacement) 방식
  - 현재 실행 중인 프로세스의 프레임들을 대상으로 교체 알고리즘을 적용하여 대상 페이지를 선정함
  - 장점: 각 프로세스마다 할당된 프레임의 전체 개수에 변화가 없음 -> 페이지 교체가 다른 프로세스에 영향을 미치지 않는다.
  - 단점: 타 프로세스에서 사용되지 않고 있는 페이지가 있을 수 있는데, 프로세스 내부 단위로만 페이지 교체가 이뤄지기 때문에 비교적 자주 사용되는 페이지가 스왑 영역으로 옮겨질 수 있음. -> 시스템 효율이 떨어짐
  - 즉, 다른 프로세스의 스레싱은 줄일 수 있으나 실행 중인 프로세스의 성능을 떨어뜨릴 수 있음
- 전체 시스템의 입장에서는 전역 교체 방식이 지역 교체 방식보다 효율적
